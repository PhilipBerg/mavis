<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ensemble Tutorial • mavis</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Ensemble Tutorial">
<meta property="og:description" content="mavis">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mavis</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/baldur-tutorial.html">Baldur-Tutorial</a>
    </li>
    <li>
      <a href="../articles/ensemble.html">Ensemble Tutorial</a>
    </li>
    <li>
      <a href="../articles/mult-imp.html">Multiple Imputation and limma</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ensemble Tutorial</h1>
                        <h4 data-toc-skip class="author">Philip
Berg</h4>
            
      
      
      <div class="hidden name"><code>ensemble.Rmd</code></div>

    </div>

    
    
<p>Here we will exemplify how to run the ensemble method using the
UPS-DS.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load Mavis</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mavis</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setup helper function to run Baldur</span></span>
<span><span class="va">baldur_wrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">design</span>, <span class="va">contrast</span>, <span class="va">gam_model</span>, <span class="va">mean_prior</span> <span class="op">=</span> <span class="va">empirical_bayes</span>, <span class="va">workers</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">uncertainty</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">mavis</span><span class="fu">::</span><span class="fu"><a href="../reference/estimate_uncertainty.html">estimate_uncertainty</a></span><span class="op">(</span><span class="st">'identifier'</span>, <span class="va">design</span>, <span class="va">gam_model</span><span class="op">)</span></span>
<span>  <span class="va">gam_model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">mavis</span><span class="fu">::</span><span class="fu"><a href="../reference/estimate_gamma_hyperparameters.html">estimate_gamma_hyperparameters</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">design</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">baldur</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/baldur/man/infer_data_and_decision_model.html" class="external-link">infer_data_and_decision_model</a></span><span class="op">(</span></span>
<span>      id_col <span class="op">=</span> <span class="st">'identifier'</span>,</span>
<span>      design_matrix <span class="op">=</span> <span class="va">design</span>,</span>
<span>      contrast_matrix <span class="op">=</span> <span class="va">contrast</span>,</span>
<span>      uncertainty_matrix <span class="op">=</span> <span class="va">uncertainty</span>,</span>
<span>      stan_model <span class="op">=</span> <span class="va">mean_prior</span>,</span>
<span>      clusters <span class="op">=</span> <span class="va">workers</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Setup input variables</span></span>
<span><span class="va">workers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">ups_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ups_design</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"fmol"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ups_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/combn.html" class="external-link">combn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ups_design</span><span class="op">)</span>, <span class="fl">2</span>, FUN <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">x</span>, collapse <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">limma</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/makeContrasts.html" class="external-link">makeContrasts</a></span><span class="op">(</span>contrasts <span class="op">=</span> <span class="va">.</span>, levels <span class="op">=</span> <span class="va">ups_design</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Normalize data</span></span>
<span><span class="va">ups_norm</span> <span class="op">&lt;-</span> <span class="va">ups</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/baldur/man/psrn.html" class="external-link">psrn</a></span><span class="op">(</span><span class="st">"identifier"</span><span class="op">)</span></span></code></pre></div>
<p>Since we will be doing imputation for Baldur and each time we run
limma; we first infer the imputation paramters.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ups_imp_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/imp.html">get_imputation_pars</a></span><span class="op">(</span><span class="va">ups_norm</span>, <span class="va">ups_design</span>, <span class="va">sd_p</span> <span class="op">~</span> <span class="va">mean</span>, <span class="va">workers</span><span class="op">)</span></span>
<span><span class="co">#&gt; Estimating Imputation Paramters</span></span>
<span><span class="co">#&gt; Previous error: Inf  &gt;   Current error: 8.695114 </span></span>
<span><span class="co">#&gt; Iteration time:</span></span>
<span><span class="co">#&gt;  28.07736 secs </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Previous error: 8.695114     &gt;   Current error: 0.08210912 </span></span>
<span><span class="co">#&gt; Iteration time:</span></span>
<span><span class="co">#&gt;  28.67895 secs </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Previous error: 0.08210912   &gt;   Current error: 0.02492085 </span></span>
<span><span class="co">#&gt; Iteration time:</span></span>
<span><span class="co">#&gt;  28.36011 secs </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Previous error: 0.02492085   &gt;   Current error: 0.01484044 </span></span>
<span><span class="co">#&gt; Iteration time:</span></span>
<span><span class="co">#&gt;  28.65222 secs </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Previous error: 0.01484044   &gt;   Current error: 0.006348059 </span></span>
<span><span class="co">#&gt; Iteration time:</span></span>
<span><span class="co">#&gt;  28.70778 secs </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Previous error: 0.006348059  &gt;   Current error: 0.005851834 </span></span>
<span><span class="co">#&gt; Iteration time:</span></span>
<span><span class="co">#&gt;  28.70757 secs </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Previous error: 0.005851834  &gt;   Current error: 0.004621849 </span></span>
<span><span class="co">#&gt; Iteration time:</span></span>
<span><span class="co">#&gt;  28.76481 secs </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Previous error: 0.004621849  &gt;   Current error: 0.003686415 </span></span>
<span><span class="co">#&gt; Iteration time:</span></span>
<span><span class="co">#&gt;  28.75814 secs </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Previous error: 0.003686415  &lt;   Current error: 0.003692812  Breaking </span></span>
<span><span class="co">#&gt; Iteration time:</span></span>
<span><span class="co">#&gt;  28.75608 secs</span></span></code></pre></div>
<p>First we will run the limma based models. To this end, we will first
estimate the trend partitioing for the data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ups_grid</span> <span class="op">&lt;-</span> <span class="va">ups_norm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/calculate_mean_sd_trends.html">calculate_mean_sd_trends</a></span><span class="op">(</span><span class="va">ups_design</span>, sdev <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/grid_search.html">grid_search</a></span><span class="op">(</span><span class="va">ups_design</span>, workers <span class="op">=</span> <span class="va">workers</span>, n_h1 <span class="op">=</span> <span class="fl">20</span>, n_h2 <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="trend_part-1.png" alt="plot of chunk trend_part"><div class="figcaption">plot of chunk trend_part</div>
</div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Look at the top parameters</span></span>
<span><span class="va">ups_grid</span></span>
<span><span class="co">#&gt; # A tibble: 400 × 5</span></span>
<span><span class="co">#&gt;         h1      h2 formula        s clustered_data          </span></span>
<span><span class="co">#&gt;      &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;     &lt;dbl&gt; &lt;list&gt;                  </span></span>
<span><span class="co">#&gt;  1 0.00724 0.102   &lt;formula&gt; 13587. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt;  2 0.00724 0.197   &lt;formula&gt; 13468. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt;  3 0.102   0.00724 &lt;formula&gt; 13381. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt;  4 0.00724 0.00724 &lt;formula&gt; 13334. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt;  5 0.00724 0.292   &lt;formula&gt; 13197. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt;  6 0.102   0.102   &lt;formula&gt; 13112. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt;  7 0.102   0.197   &lt;formula&gt; 12727. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt;  8 0.197   0.00724 &lt;formula&gt; 12601. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt;  9 0.00724 0.482   &lt;formula&gt; 12303. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt; 10 0.197   0.102   &lt;formula&gt; 12260. &lt;spc_tbl_ [10,599 × 16]&gt;</span></span>
<span><span class="co">#&gt; # ℹ 390 more rows</span></span></code></pre></div>
<p>We can then extract the dataset with the highest score.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ups_part</span> <span class="op">&lt;-</span> <span class="va">ups_grid</span><span class="op">$</span><span class="va">clustered_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">ups_grid</span><span class="op">)</span></span>
<span><span class="va">ups_part</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/plot_gamma_partition.html">plot_gamma_partition</a></span><span class="op">(</span><span class="va">ups_design</span>, formula <span class="op">=</span> <span class="va">sd</span> <span class="op">~</span> <span class="va">mean</span> <span class="op">+</span> <span class="va">c</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="score-1.png" alt="plot of chunk score"><div class="figcaption">plot of chunk score</div>
</div>
<p>Next we run the multiple imputation and produce the median log<span class="math inline">\(_2\)</span>-fold change and p-value which we will
use in the ensemble.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">limma_trend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiple_imputation_and_limma.html">multiple_imputation_and_limma</a></span><span class="op">(</span><span class="va">ups_part</span>, <span class="va">ups_design</span>, <span class="va">ups_cont</span>,</span>
<span>                                             <span class="fl">1000</span>, <span class="va">workers</span>, <span class="st">"identifier"</span>,</span>
<span>                                             imp_pars <span class="op">=</span> <span class="va">ups_imp_pars</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/extract_results.html">extract_results</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.05</span>, pcor <span class="op">=</span> <span class="st">"fdr"</span>, id_col <span class="op">=</span> <span class="st">"identifier"</span><span class="op">)</span></span>
<span><span class="va">limma_gr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiple_imputation_and_limma.html">multiple_imputation_and_limma</a></span><span class="op">(</span><span class="va">ups_part</span>, <span class="va">ups_design</span>, <span class="va">ups_cont</span>,</span>
<span>                                          <span class="fl">1000</span>, <span class="va">workers</span>, <span class="st">"identifier"</span>,</span>
<span>                                          imp_pars <span class="op">=</span> <span class="va">ups_imp_pars</span>,</span>
<span>                                          weights <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                          formula_weights <span class="op">=</span> <span class="va">sd</span> <span class="op">~</span> <span class="va">mean</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/extract_results.html">extract_results</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.05</span>, pcor <span class="op">=</span> <span class="st">"fdr"</span>, id_col <span class="op">=</span> <span class="st">"identifier"</span><span class="op">)</span></span>
<span><span class="va">limma_gcr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiple_imputation_and_limma.html">multiple_imputation_and_limma</a></span><span class="op">(</span><span class="va">ups_part</span>, <span class="va">ups_design</span>, <span class="va">ups_cont</span>,</span>
<span>                                           <span class="fl">1000</span>, <span class="va">workers</span>, <span class="st">"identifier"</span>,</span>
<span>                                           imp_pars <span class="op">=</span> <span class="va">ups_imp_pars</span>,</span>
<span>                                           weights <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                           formula_weights <span class="op">=</span> <span class="va">sd</span> <span class="op">~</span> <span class="va">mean</span> <span class="op">+</span> <span class="va">c</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/extract_results.html">extract_results</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.05</span>, pcor <span class="op">=</span> <span class="st">"fdr"</span>, id_col <span class="op">=</span> <span class="st">"identifier"</span><span class="op">)</span></span></code></pre></div>
<p>Next we want to run the Baldur methods and to make it even we will
also use the weakly informative prior so we get three of each method
type. But first we have to do the imputation and then multi trend
partitioning.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ups_imp</span>   <span class="op">&lt;-</span> <span class="fu"><a href="../reference/imp.html">single_imputation</a></span><span class="op">(</span><span class="va">ups_norm</span>,</span>
<span>                               <span class="va">ups_design</span>,</span>
<span>                               formula <span class="op">=</span> <span class="va">sd_p</span> <span class="op">~</span> <span class="va">mean</span>,</span>
<span>                               workers <span class="op">=</span> <span class="va">workers</span>,</span>
<span>                               imp_pars <span class="op">=</span> <span class="va">ups_imp_pars</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/calculate_mean_sd_trends.html">calculate_mean_sd_trends</a></span><span class="op">(</span><span class="va">ups_design</span><span class="op">)</span></span>
<span><span class="va">ups_imp_part</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/grid_search.html">grid_search</a></span><span class="op">(</span><span class="va">ups_imp</span>,</span>
<span>                            <span class="va">ups_design</span>,</span>
<span>                            workers <span class="op">=</span> <span class="va">workers</span>,</span>
<span>                            n_h1 <span class="op">=</span> <span class="fl">20</span>, n_h2 <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Get the data column</span></span>
<span>  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">use_series</a></span><span class="op">(</span><span class="va">clustered_data</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Get the first instance (i.e., highest score)</span></span>
<span>  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">extract2</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="baldur-1.png" alt="plot of chunk baldur"><div class="figcaption">plot of chunk baldur</div>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr_ups</span>       <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/baldur/man/fit_gamma_regression.html" class="external-link">fit_gamma_regression</a></span><span class="op">(</span><span class="va">ups_imp</span><span class="op">)</span></span>
<span><span class="va">gcr_ups</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/baldur/man/fit_gamma_regression.html" class="external-link">fit_gamma_regression</a></span><span class="op">(</span><span class="va">ups_imp_part</span>, <span class="va">sd</span> <span class="op">~</span> <span class="va">mean</span> <span class="op">+</span> <span class="va">c</span><span class="op">)</span></span>
<span><span class="va">gr_baldur</span>    <span class="op">&lt;-</span> <span class="fu">baldur_wrapper</span><span class="op">(</span><span class="va">ups_imp</span>,</span>
<span>                             <span class="va">ups_design</span>,</span>
<span>                             <span class="va">ups_cont</span>,</span>
<span>                             <span class="va">gr_ups</span>,</span>
<span>                             workers <span class="op">=</span> <span class="va">workers</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gcr_baldur</span> <span class="op">&lt;-</span> <span class="fu">baldur_wrapper</span><span class="op">(</span><span class="va">ups_imp_part</span>,</span>
<span>                             <span class="va">ups_design</span>,</span>
<span>                             <span class="va">ups_cont</span>,</span>
<span>                             <span class="va">gcr_ups</span>,</span>
<span>                             workers <span class="op">=</span> <span class="va">workers</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gcr_wi_baldur</span> <span class="op">&lt;-</span> <span class="fu">baldur_wrapper</span><span class="op">(</span><span class="va">ups_imp_part</span>,</span>
<span>                             <span class="va">ups_design</span>,</span>
<span>                             <span class="va">ups_cont</span>,</span>
<span>                             <span class="va">gcr_ups</span>,</span>
<span>                             mean_prior <span class="op">=</span> <span class="va">weakly_informative</span>,</span>
<span>                             workers <span class="op">=</span> <span class="va">workers</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we can start adding the methods to the ensemble.
<code>mavis</code> ensemble object is very similar to a data stack
structure. In addition, we will strip the results of each method down to
the essential columns and remove them from our global environment to
save up on memory.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Start a new instance of the ensemble</span></span>
<span><span class="va">ups_ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/start_ensemble.html">start_ensemble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ups_ens</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span></span>
<span>  <span class="va">limma_trend</span>, <span class="st">"limma-trend"</span>, <span class="st">"identifier"</span>, <span class="st">"median_p_val"</span>, <span class="st">"median_lfc"</span>,</span>
<span>  auxilary <span class="op">=</span> <span class="st">"none"</span>, do_rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span></span>
<span>  <span class="va">limma_gr</span>, <span class="st">"gr-limma"</span>, <span class="st">"identifier"</span>, <span class="st">"median_p_val"</span>, <span class="st">"median_lfc"</span>,</span>
<span>  auxilary <span class="op">=</span> <span class="st">"none"</span>, do_rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span></span>
<span>  <span class="va">limma_gcr</span>, <span class="st">"gcr-limma"</span>, <span class="st">"identifier"</span>, <span class="st">"median_p_val"</span>, <span class="st">"median_lfc"</span>,</span>
<span>  auxilary <span class="op">=</span> <span class="st">"none"</span>, do_rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span></span>
<span>  <span class="va">gr_baldur</span>, <span class="st">"gr-balur"</span>, <span class="st">"identifier"</span>, <span class="st">"err"</span>, <span class="st">"lfc"</span>,</span>
<span>  auxilary <span class="op">=</span> <span class="st">"none"</span>, do_rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span></span>
<span>  <span class="va">gcr_baldur</span>, <span class="st">"gcr-balur"</span>, <span class="st">"identifier"</span>, <span class="st">"err"</span>, <span class="st">"lfc"</span>,</span>
<span>  auxilary <span class="op">=</span> <span class="st">"none"</span>, do_rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span></span>
<span>  <span class="va">gcr_wi_baldur</span>, <span class="st">"gcr-balur-wi"</span>, <span class="st">"identifier"</span>, <span class="st">"err"</span>, <span class="st">"lfc"</span>,</span>
<span>  auxilary <span class="op">=</span> <span class="st">"none"</span>, do_rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Available methods</span></span>
<span><span class="va">ups_ens</span></span>
<span><span class="co">#&gt; Ensemble Stack of 6</span></span>
<span><span class="co">#&gt; Methods Available: limma-trend, gr-limma, gcr-limma, gr-balur, gcr-balur, gcr-balur-wi</span></span></code></pre></div>
<p>Then we can run the ensemble with <code>$run_ensemble</code>. Since I
have 8 cores if I use half of the available once, I will add one more to
make it nine.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">workers</span></span>
<span><span class="co">#&gt; [1] 8</span></span>
<span><span class="va">workers</span> <span class="op">&lt;-</span> <span class="va">workers</span> <span class="op">+</span> <span class="fl">1</span></span></code></pre></div>
<p>For the UPS-DS (as defined here) there are three comparisons, we
could run two parallel instances each with 4 parallel chains (eight
total in parellel) to speed up the process. But since I decided to use
nine cores, I can run three chains on three parallel instances so that
all comparisons can be ran at the same time.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ups_ens_results</span> <span class="op">&lt;-</span> <span class="va">ups_ens</span><span class="op">$</span><span class="fu">run_ensemble</span><span class="op">(</span>parallel_chains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                        parallel_runs <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                        <span class="co"># Additional arguments to rstan::sample</span></span>
<span>                                        <span class="co"># to adjust for running one chain less</span></span>
<span>                                        chains <span class="op">=</span> <span class="fl">3</span>, iter <span class="op">=</span> <span class="fl">2400</span>, warmup <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ups_ens_results</span></span>
<span><span class="co">#&gt; # A tibble: 31,797 × 5</span></span>
<span><span class="co">#&gt;    identifier                                                  comparison        p_val n_eff  Rhat</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;                                                       &lt;chr&gt;             &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 Cre01.g000350.t1.1|PACid:30788481|--AVLLFATGSGISPLR         fmol25 vs fmol100 0.700 2064.  1.00</span></span>
<span><span class="co">#&gt;  2 Cre01.g000350.t1.1|PACid:30788481|--AVLLFATGSGISPLR         fmol25 vs fmol100 0.820 2020.  1.00</span></span>
<span><span class="co">#&gt;  3 Cre01.g000350.t1.1|PACid:30788481|--AVLLFATGSGISPLR         fmol25 vs fmol100 0.920 2312.  1.00</span></span>
<span><span class="co">#&gt;  4 Cre01.g000350.t1.1|PACid:30788481|--GFALDRLPASTTR           fmol25 vs fmol100 0.623 2330.  1.00</span></span>
<span><span class="co">#&gt;  5 Cre01.g000350.t1.1|PACid:30788481|--GFALDRLPASTTR           fmol25 vs fmol100 0.590 1818.  1.00</span></span>
<span><span class="co">#&gt;  6 Cre01.g000350.t1.1|PACid:30788481|--GFALDRLPASTTR           fmol25 vs fmol100 0.966 2384.  1.00</span></span>
<span><span class="co">#&gt;  7 Cre01.g000350.t1.1|PACid:30788481|--VVIDVGAPLAAGYTVPGQFVQVK fmol25 vs fmol100 0.886 1524.  1.00</span></span>
<span><span class="co">#&gt;  8 Cre01.g000350.t1.1|PACid:30788481|--VVIDVGAPLAAGYTVPGQFVQVK fmol25 vs fmol100 0.623 2112.  1.00</span></span>
<span><span class="co">#&gt;  9 Cre01.g000350.t1.1|PACid:30788481|--VVIDVGAPLAAGYTVPGQFVQVK fmol25 vs fmol100 0.764 2686.  1.00</span></span>
<span><span class="co">#&gt; 10 Cre01.g000350.t1.1|PACid:30788481|--VVSVYSESK               fmol25 vs fmol100 0.720 1832.  1.00</span></span>
<span><span class="co">#&gt; # ℹ 31,787 more rows</span></span></code></pre></div>
<p>By default all the methods in the the stack will be ran but we can
specify which methods to run with the <code>methods</code> argument.
But, we could either <code>$pop</code> out methods back to our global
environment, or we could define a subset of methods to run. Finally, we
could run three parallel chains on three parallel instances instead of
four and two so that all three comparisons can be ran at the same
time.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run a limma specific ensemble</span></span>
<span><span class="va">ups_limma_ens_results</span> <span class="op">&lt;-</span> <span class="va">ups_ens</span><span class="op">$</span><span class="fu">run_ensemble</span><span class="op">(</span>methods <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,</span>
<span>                                              parallel_chains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                              parallel_runs <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                              chains <span class="op">=</span> <span class="fl">3</span>, iter <span class="op">=</span> <span class="fl">2400</span>, warmup <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Alternatively to 1:3 we could have called the methods by name</span></span>
<span><span class="co"># method = c("limma-trend", paste0(c("gr", "gcr"), "-limma"))</span></span>
<span><span class="co"># Running Baldur specific methods by first removing the limma ones</span></span>
<span><span class="va">ups_ens</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `pop`.</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): attempt to apply non-function</span></span>
<span><span class="va">ups_baldur_ens_results</span> <span class="op">&lt;-</span> <span class="va">ups_ens</span><span class="op">$</span><span class="fu">run_ensemble</span><span class="op">(</span>parallel_chains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                               parallel_runs <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                               chains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                               iter <span class="op">=</span> <span class="fl">2400</span>, warmup <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Philip Berg.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
